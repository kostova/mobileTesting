function InitializePromiseChainGlobals(a){chainArgs=a,ts=new TelerikTesting,Q=ts.Q,executionErrors=[],spec=ts.spec.bind(ts),describe=ts.describe.bind(ts),test=ts.test.bind(ts),step=ts.step.bind(ts),web=ts.api.web,ios=ts.api.ios,android=ts.api.android,wp8=ts.api.wp8,assert=ts.api.assert,restclient=ts.api.restclient;var b=require("./CLIReporter.js");new b(ts.executionManager,chainArgs.verbose),ts.executionManager.on("executionError",function(a,b,c){executionErrors.push(a.platformInfo.name+" "+a.platformInfo.platform),console.log(a.platformInfo.name+" - "+b.type+" EXECUTION ERROR: "+c.description)}),ts.on("error",function(a){throw a})}function Connect(){var a,b=Q.defer(),c=chainArgs.messageServerUrl;chainArgs.socketsServerAddress&&(c=chainArgs.socketsServerAddress,ts.context.change(ts.context.availableContexts.USB));try{ts.agentManager.connect(c,chainArgs.sharedKey,chainArgs.messageTimeout,function(){console.log("Connected to message server."),clearTimeout(a),b.resolve()}),a=setTimeout(function(){console.log("Unable to connect to message server."),b.reject("Connection timed out")},5e3)}catch(d){b.reject(d)}return b.promise}function Error(a){console.log("Finished with error(s):",a),process.exit(1)}function Complete(){console.log("Operation Complete"),process.exit(exitCode)}function RunCtrlOperation(a){var b=Q.defer();if(agents.length>1)return b.reject("Multiple agents are connected, please specify a single agent to use."),b.promise;var c=agents[0];return ts.runOperation(a,c,function(a,c){a?b.reject(a):c.isPass()?b.resolve():b.reject(c.outputResult.details.value)}),b.promise}function LaunchApp(){if(chainArgs.app)return RunCtrlOperation(ts.api.ctrl.launchApp(chainArgs.app));throw"No app was specified."}function CloseApp(){return RunCtrlOperation(ts.api.ctrl.closeApp())}function GetElements(){return RunCtrlOperation(ts.api.ctrl.getElements(function(a){console.log(a)}))}function HighlightElement(){if(chainArgs.cancel)return RunCtrlOperation(ts.api.ctrl.highlightElementCancel());if(chainArgs.identifier)return RunCtrlOperation(ts.api.ctrl.highlightElementByIdentifier(chainArgs.identifier));if(chainArgs.query)return RunCtrlOperation(ts.api.ctrl.highlightElementByQuery(JSON.parse(chainArgs.query)));throw"No identifier or query was specified."}function Subscribe(){return RunCtrlOperation(ts.api.ctrl.subscribe()).then(function(){ts.agentManager.on("notify.descriptorRecorded",function(a){console.log(JSON.stringify(a))})})}function ConnectToAgent(){var a=Q.defer();if(!chainArgs.address)throw"No address was specified.";return ts.agentManager.connectToAgent(chainArgs.address,chainArgs.sharedKey,chainArgs.messageTimeout,function(b,c){b?a.reject(b.result.reason):(console.log(c.result.reason),a.resolve())}),a.promise}function DisconnectFromAgents(){var a=Q.defer();if(!chainArgs.agents||chainArgs.agents.length<=0)throw"No agent(s) were specified.";return ts.agentManager.disconnectFromAgents(chainArgs.agents,chainArgs.sharedKey,function(b,c){b?a.reject(b.result.reason):(console.log(c.result.reason),a.resolve())}),a.promise}function GetAgents(){var a=Q.defer();return ts.agentManager.getExecutionAgents(function(b,c){b?a.reject(b):c.length>0?(console.log("Retrieved",c.length,"Agent(s)"),a.resolve(c)):a.reject("No Agents available")}),a.promise}function FilterAgents(a){var b=[];if(!chainArgs.agents)return agents=a,new Q;if("undefined"!=typeof chainArgs.agents&&chainArgs.agents.length>0){for(var c in a)~chainArgs.agents.indexOf(a[c].id)&&b.push(a[c]);if(b.length<1)return new Q.reject("User provided Agent ID(s) did not match any Agents");console.log("Using",b.length,"of",a.length,"retrieved agent(s)")}else b=a;return agents=b,new Q}function LogAgents(a){var b;console.log(""),console.log("Agent Id; Name; Details; Platform"),console.log("----------------------");for(var c in a)b=a[c],"web"===b.platformInfo.platformKey?console.log(b.id+"; "+b.platformInfo.name+"; "+b.platformInfo.browser.version+"; "+b.platformInfo.platform):console.log(b.id+"; "+b.platformInfo.name+"; "+b.platformInfo.systemVersion+"; "+b.platformInfo.platform);return console.log(""),Q.defer().resolve()}function LoadSpecs(){var deferred=Q.defer(),fileList,matcher=new RegExp(chainArgs.matcher);~chainArgs.specsPath.search(/\/$/)||(chainArgs.specsPath+="/");try{fileList=fs.readdirSync(chainArgs.specsPath)}catch(e){deferred.reject("Could not load directory '"+chainArgs.specsPath+"'")}return void 0!==fileList&&(fileList.forEach(function(fileName){if(~fileName.search(matcher)&&(!chainArgs.files||chainArgs.files&&~chainArgs.files.indexOf(fileName))){var specString=fs.readFileSync(chainArgs.specsPath+fileName,"utf8");try{!function(){eval(specString)}()}catch(err){throw fileName+" is not a valid spec file"}}}),deferred.resolve()),deferred.promise}function GetSuites(){var a={};if(void 0!==chainArgs.filter)try{var b=fs.readFileSync(chainArgs.filter,"utf8");a=0===b.trim().length?ts.getSuites():JSON.parse(b)}catch(c){return Q.reject(chainArgs.filter+" is not a valid filter file")}else a=ts.getSuites();return Object.keys(a).length>0?Q.resolve(a):Q.reject("No Suites were retrieved")}function FilterSuites(a){var b={},c=0;if(console.log("Retrieved",Object.keys(a).length,"Suite(s)"),void 0!==chainArgs.suites&&chainArgs.suites.length>0){c=chainArgs.suites.length;for(var d in a)~chainArgs.suites.indexOf(d)&&(b[d]=a[d],c--);if(Object.keys(b).length<1)return new Q.reject("User provided Suite(s) did not match any Suites");console.log("Using",Object.keys(b).length,"of",Object.keys(a).length,"retrieved Suites(s)",c>0?c+" user provided Suites were ignored":"")}else b=a;return suites=b,new Q}function RunSuites(){if("none"!==chainArgs.screenshotsMode&&chainArgs.screenshots){fs.mkdir(chainArgs.screenshots,function(a){!a||a&&"EEXIST"===a.code});var a=new EMDefaultResultBuilder;a.screenshotCallback=function(a,b){fs.writeFile(chainArgs.screenshots+"/"+a,b,"base64",function(){})},ts.executionManager.setBuilder(a),agents.forEach(function(a){a.screenshotsMode=chainArgs.screenshotsMode,a.screenshotsEnabled=!0})}var b,c=Q.defer();return console.log("Executing Tests"),ts.runSpecificSuitesAndTests(suites,agents,function(a,d){a?(b=a.description,a.error.exception&&a.error.exception.reason&&(b+=" "+a.error.exception.reason),c.reject(b)):c.resolve(d)}),c.promise}function LogSuites(a){console.log(""),console.log("Suite Description; Test1; Test2; ..."),console.log("------------------------------------");var b="";for(var c in a){b=c+"; ";for(var d in a[c])b+=a[c][d]+"; ";console.log(b)}return console.log(""),Q.defer().resolve()}function LogResults(a){var b=require("./resultReporter.js"),c=b.report(chainArgs,executionErrors,a);return c||(exitCode=1),a}function PublishResults(a){if(!chainArgs.publish)return Q(a);var b=Q.defer(),c=chainArgs.apiKey,d=chainArgs.projectId,e=chainArgs.publishUrl;return restclient.postResults(e,d,c,JSON.stringify(a),function(c){c?console.log("Error publishing results: "+JSON.parse(c.content).Message):console.log("Results published successfully"),b.resolve(a)}),b.promise}function SaveResultFile(a){return"string"==typeof chainArgs.outputFile&&fs.writeFileSync(chainArgs.outputFile,JSON.stringify(a)),Q(a)}var TelerikTesting=require("telerikTesting").TelerikTesting,EMDefaultResultBuilder=require("telerikTesting").EMDefaultResultBuilder,fs=require("fs"),chainArgs,executionErrors,exitCode=0,ts,Q,agents,suites,spec,describe,test,step,web,ios,android,wp8,assert,restclient,executionCmds={getAgents:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(GetAgents).then(LogAgents).catch(Error).then(Complete)}},getSuites:{execute:function(a){InitializePromiseChainGlobals(a),Q.invoke(LoadSpecs).then(GetSuites).then(LogSuites).catch(Error).then(Complete)}},connectToAgent:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(ConnectToAgent).catch(Error).then(Complete)}},disconnectFromAgents:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(DisconnectFromAgents).catch(Error).then(Complete)}},launchApp:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(GetAgents).then(FilterAgents).then(LaunchApp).catch(Error).then(Complete)}},closeApp:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(GetAgents).then(FilterAgents).then(CloseApp).catch(Error).then(Complete)}},getElements:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(GetAgents).then(FilterAgents).then(GetElements).catch(Error).then(Complete)}},highlightElement:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(GetAgents).then(FilterAgents).then(HighlightElement).catch(Error).then(Complete)}},subscribe:{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(GetAgents).then(FilterAgents).then(Subscribe).catch(Error)}},"default":{execute:function(a){InitializePromiseChainGlobals(a),Connect().then(GetAgents).then(FilterAgents).then(LoadSpecs).then(GetSuites).then(FilterSuites).then(RunSuites).then(LogResults).then(PublishResults).then(SaveResultFile).catch(Error).then(Complete)}}};module.exports=executionCmds;