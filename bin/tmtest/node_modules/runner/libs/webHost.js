function PreventCaching(a){a.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),a.setHeader("Pragma","no-cache"),a.setHeader("Expires","0")}function DecorateMimeType(a,b){var c=b.substring(b.lastIndexOf("."),b.length),d=null;switch(c){case".html":d="text/html";break;case".js":d="text/javascript";break;case".css":d="text/css"}d&&a.setHeader("Content-Type",d)}function DecorateErrorResponse(a){a.writeHead(404,{"Content-Type":"text/plain"}),a.write("404 Not Found\n"),a.end()}function DecorateBinaryResonse(a,b){a.writeHead(200),a.write(b,"binary"),a.end()}function LoadFileIntoResponse(a,b,c){fs.exists(b,function(d){return d?(fs.readFile(b,"binary",function(d,e){return d?(DecorateErrorResponse(a),void 0):(c&&PreventCaching(a),DecorateMimeType(a,b),DecorateBinaryResonse(a,e),void 0)}),void 0):(DecorateErrorResponse(a),void 0)})}function NormalizeUrl(a){var b=a.indexOf("?");return-1!==b&&(a=a.substring(0,b)),a=decodeURI(a.toLowerCase())}function HandleHttpRequest(a,b){var c=null,d=NormalizeUrl(a.url);if("/"===d)return b.writeHead(302,{Location:agentRedirectUrl}),b.end(),void 0;if("/testrunner"===d||"/testrunner/"===d)return b.writeHead(302,{Location:testRunnerRedirectUrl}),b.end(),void 0;for(var e in folderMap)if(0===d.indexOf(e))return c=d.replace(e,folderMap[e].path),LoadFileIntoResponse(b,c,folderMap[e].noCache),void 0;DecorateErrorResponse(b)}function FormatSocketMessage(a,b){return JSON.stringify({message:a,data:b})}function BroadcastMessage(a){wsServer.connections.forEach(function(b){b.sendUTF(a)})}function HandleSettingsUpdated(){specs.updateSpecFolder(settings.data.specFolder),BroadcastMessage(FormatSocketMessage(GET_SETTINGS_RES_CMD,settings.data))}function HandleSpecFilesUpdate(a,b){folderMap[SPECS_PREFIX].path=a,specFiles=[];for(var c=0;c<b.length;c++)specFiles.push(SPECS_PREFIX+b[c]);BroadcastMessage(FormatSocketMessage(GET_SPECS_RES_CMD,specFiles))}function FindIpAddress(){var a=os.networkInterfaces();for(var b in a)for(var c=0;c<a[b].length;c++){var d=a[b][c];if("IPv4"===d.family&&!d.internal&&-1===b.indexOf("Windows Phone"))return d.address}return"127.0.0.1"}function CopyObject(a,b){for(var c in a)b[c]=a[c]}function HandleSocketRequest(a){var b=a.accept(null,a.origin);b.on("message",function(a){var c=null;if("utf8"===a.type){try{c=JSON.parse(a.utf8Data)}catch(d){}if(c&&c.message)switch(c.message){case GET_SETTINGS_CMD:b.sendUTF(FormatSocketMessage(GET_SETTINGS_RES_CMD,settings.data));break;case SET_SETTINGS_CMD:c.data&&(CopyObject(c.data,settings.data),settings.persist());break;case GET_SPECS_CMD:specFiles?b.sendUTF(FormatSocketMessage(GET_SPECS_RES_CMD,specFiles)):specs.requestSpecs();break;case GET_IP_ADDRESS_CMD:b.sendUTF(FormatSocketMessage(GET_IP_ADDRESS_RES_CMD,ipAddress));break;case GET_INIT_DATA_CDM:b.sendUTF(FormatSocketMessage(GET_INIT_DATA_RES_CDM,{address:msgServerAddress,timeout:msgTimeout}));break;case START_AGENTS_DATA_CMD:c.data&&c.data.url&&Array.isArray(c.data.agents)&&settings.data.browsers&&c.data.agents.forEach(function(a){open(c.data.url,settings.data.browsers[a])})}}})}function GenerateFolderMap(){var a={},b=process.cwd();return a[CORE_PREFIX]={path:path.join(b,"/libs/"),noCache:!1},a[SPECS_PREFIX]={path:path.join(b,"../samples/Web/specs/"),noCache:!0},a[RUNNER_PREFIX]={path:path.join(b,"/testRunner/"),noCache:!1},a}var consoleWarn=console.warn;console.warn=function(){};var http=require("http"),path=require("path"),WebSocketServer=require("websocket").server,fs=require("fs"),open=require("open"),os=require("os"),settings=require("./settings.js"),specs=require("./specs.js");console.warn=consoleWarn;var httpServer,wsServer,webHost,ipAddress,agentRedirectUrl,testRunnerRedirectUrl,folderMap={},msgServerAddress,msgTimeout,specFiles,GET_INIT_DATA_CDM="getInitData",GET_INIT_DATA_RES_CDM="getInitDataResponse",GET_SETTINGS_CMD="getSettings",GET_SETTINGS_RES_CMD="getSettingsResponse",SET_SETTINGS_CMD="setSettings",GET_SPECS_CMD="getSpecs",GET_SPECS_RES_CMD="getSpecsResponse",GET_IP_ADDRESS_CMD="getIpAddress",GET_IP_ADDRESS_RES_CMD="getIpAddressResponse",START_AGENTS_DATA_CMD="startAgents",CORE_PREFIX="/core/",SPECS_PREFIX="/specs/",RUNNER_PREFIX="/testrunner/",GET_SEPARATOR="&_=";webHost={start:function(a,b,c,d){folderMap=GenerateFolderMap(),ipAddress=FindIpAddress(),msgServerAddress=b,msgTimeout=c,agentRedirectUrl="http://"+ipAddress+":"+a+"/testRunner/agent.html?messageServerUrl="+encodeURIComponent(b)+"&timeout="+c,testRunnerRedirectUrl="http://"+ipAddress+":"+a+"/testRunner/index.html",settings.on(settings.events.updated,HandleSettingsUpdated),specs.on(specs.events.updated,HandleSpecFilesUpdate),httpServer=http.createServer(HandleHttpRequest),wsServer=new WebSocketServer({httpServer:httpServer,autoAcceptConnections:!1}),wsServer.on("request",HandleSocketRequest),httpServer.listen(a,null,null,d),specs.updateSpecFolder(settings.data.specFolder),process.on("SIGINT",function(){process.exit()}),httpServer.on("error",function(b){"EADDRINUSE"===b.code||"EACCES"===b.code?console.log("Port",a,"already in use."):(console.log("An unexpected error has occured"),console.log(b)),process.exit(1)})}},module.exports=webHost;