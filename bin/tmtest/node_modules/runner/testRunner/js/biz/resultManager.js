!function(){function a(a,b,c){for(var d=null,e=0;e<a.length;e++)if(b(a[e])){d=a[e];break}return null===d&&(d=c(),a.push(d)),d}function b(a){for(var b={step:0,message:"",name:"",operationName:"",operationNumber:0,stackTrace:""},c=0;c<a.length;c++){var d=a[c];if(d.status===k)for(var e=0;e<d.results.length;e++)if(d.results[e].status===k){var f=d.results[e].details.value;return b.step=c+1,b.message="string"==typeof f?f:f.message,b.name=d.name,b.operationName=d.results[e].name,b.operationNumber=e+1,b.stackTrace=f.stack||"",b}}return b}function c(c,d){if(d=d||[],q={},c)return o=[],void 0;var e=[];if(o=d,d.forEach(function(c){c.results.forEach(function(d){var f=a(e,function(a){return a.name===d.name},function(){return{name:d.name,agents:{},agentsLabel:"",failInfo:[]}});if(f.status!==k&&(f.status=d.status),f.agents[c.agent.id]||(f.agents[c.agent.id]=c.agent,f.agentsLabel+="<div>",f.agentsLabel+=c.agent.platformInfo.name+" "+c.agent.platformInfo.platform,f.agentsLabel+="</div>"),(!f.startTime||f.startTime>f.startTime)&&(f.startTime=moment(d.startTime).format("MMMM DD YYYY, h:mm:ss a")),(!f.endTime||f.endTime<f.endTime)&&(f.endTime=moment(d.endTime).format("MMMM DD YYYY, h:mm:ss a")),!f.duration){var g=moment(d.endTime).diff(moment(d.startTime));f.duration=moment.duration(g).format()}if(d.status===k){var h=d.results.filter(function(a){return a.status===k});h.forEach(function(a){var d=b(a.results);f.failInfo.push({agentName:c.agent.platformInfo.name,platform:c.agent.platformInfo.platform,test:a.name,step:d.name,stepNumber:d.step,operationName:d.operationName,operationNumber:d.operationNumber,errorMessage:d.message,stackTrace:d.stackTrace})})}})}),executionErrors.length){var f=[];f.push(executionErrors.length+(1===executionErrors.length?" Agent ":" Agents ")+"stopped responding during execution"),f.push("<ul class='errors'>"),executionErrors.forEach(function(a){f.push("<li>"+a+"</li>")}),f.push("</ul>"),tsUtils.popNotification(f.join(""),"error"),executionErrors=[]}m.data(e),uiRouter.changeResultState("results"),uiRouter.navigate("/results")}function d(a){p=a}function e(){return q[p.publishURL]?(tsUtils.popNotification("Error publishing results: Duplicate â€“ results already published.","error"),void 0):(telerikTesting.api.restclient.postResults(p.publishURL,p.projectKey,p.apiKey,JSON.stringify(o),function(a,b){if(!a&&b&&b.wasSuccessful)tsUtils.popNotification("Results published successfully","success"),q[p.publishURL]=!0;else{var c;if(a)try{c=JSON.parse(a.content)}catch(d){return tsUtils.popNotification("Error communicating with server","error"),uiRouter.changeResultState("results"),void 0}else tsUtils.popNotification("Error communicating with server. Please try again later.","error");console.log("Publish Results: FAIL - "+new Date),tsUtils.popNotification("Error publishing results: "+c.Message,"error")}uiRouter.changeResultState("results")}),uiRouter.changeResultState("publishing"),void 0)}function f(){var a=kendo.template($("#publishInfoContent").html()),b=tsUtils.popModal("Publish Results to Telerik Platform",a(p),{"click #picSaveBtn":h},{width:520,hide:!0});kendo.bind(b.element,kendo.observable({selectedOption:"TelerikPlatform",telerikPlatformSelected:function(){return"TelerikPlatform"===this.get("selectedOption")}})),b.center().open()}function g(){return p.projectKey&&p.apiKey?(e(),void 0):(f(),void 0)}function h(){var a=this.element.find("#picProjectIdText"),b=this.element.find("#picApiKeyText"),c=this.element.find("#picCustomURLText"),d=[{$el:a,rules:[{msg:"is required",rule:function(a){return!!a}},{msg:"is invalid",rule:function(a){return-1!==a.indexOf("-")}}]},{$el:b,rules:[{msg:"is required",rule:function(a){return!!a}},{msg:"is invalid",rule:function(a){return-1===a.indexOf("-")}}]}];c.is(":visible")?d.push({$el:c,rules:[{msg:"is required",rule:function(a){return!!a}}]}):c.val(""),tsUtils.validate(d)&&(p.publishURL=c.val(),p.projectKey=a.val(),p.apiKey=b.val(),localRes.writeSettings(p),a.val(""),b.val(""),e(),this.closeAndDestroy())}function i(a){var b,c,d,e,f=m.getByUid(a),g=f.failInfo;n.data(g),b=j(),c=$($("#resultInfoContent").html().trim()),c.find("#resultInfoGrid").append(b.element),d=$("<div>").append(c.clone()).html(),e=tsUtils.popModal(f.name+": Failure Details",d,{"click #picSaveBtn":h},{hide:!0}),e.element.find("#resultInfoGrid").html("").append(b.element),$(e.wrapper).css("width","80%"),e.element.find(".exception-detail").kendoTooltip({position:"top",width:"auto",height:"auto",autoHide:!1,content:function(a){var b=$(a.target).attr("data-tooltip").replace(/\n/g,"<br />");return"<div>"+b+"</div>"}}),e.center().open()}function j(){var a=$("<div></div").kendoGrid({dataSource:n,groupable:!1,sortable:!1,columns:[{field:"errorMessage",title:" ",template:"<i class='fail icon-remove-sign'></i>",width:13},{field:"agentName",title:"Agent",width:30},{field:"platform",title:"Platform",width:30},{field:"test",title:"Failed Test",width:50},{field:"step",title:"Failed Step",template:"<span class='stepNum'>#: stepNumber #.</span> #: step #",width:50},{field:"operation",title:"Failed Method",template:"<span class='stepNum'>#: operationNumber #.</span> #: operationName #",width:50},{field:"errorMessage",title:"Exception",width:50},{field:"",title:"",template:"#if(stackTrace.length>0){#<a class='exception-detail' data-tooltip='#: stackTrace #'><i class='icon-plus-sign'></i></a>#}#",width:13}]}).data("kendoGrid");return a.table.addClass("data-panel common-grid"),a}var k="FAIL",l=null,m=null,n=null,o=[],p={},q={};localRes.onSettingsReceived(d),$(document).ready(function(){testRunner.onRunCompleted.push(c),m=new kendo.data.DataSource({data:[]}),l=$("#resultView").kendoGrid({dataSource:m,groupable:!1,sortable:!0,columns:[{field:"status",title:" ",width:40,template:kendo.template($("#resultColumnTemplate").html())},{field:"name",title:"Test Suite"},{field:"agentsLabel",title:"Agents",template:"#= agentsLabel #"},{field:"startTime",title:"Started"},{field:"duration",title:"Duration"}]}).data("kendoGrid"),l.bind("dataBound",function(){$("#resultView i.fail").each(function(a,b){$(b).closest("tr").addClass("fail")})}),$("#resultView").on("click","tr.fail",function(a){i($(a.currentTarget).attr("data-uid"))}),n=new kendo.data.DataSource({data:[]}),$("#publishBtn").click(g)})}();