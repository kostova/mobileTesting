function ServerHandshakeState1(){}function ServerHandshakeState2(){this._connectionTimeout=null}function ServerHandshakeRejected(){}function ServerHandshakeResumed(){}var ElevatedState=require("./AutomationState.js").ElevatedState,automationMessageFactory=require("./automationMessageFactory.js"),logger=require("./logger.js"),AutomationRunnerStates=require("./AutomationRunnerStates.js"),AutomationAgentStates=require("./AutomationAgentStates.js"),TSProtocol=require("./TsAutomationProtocol.js"),validation=require("./Validation.js");ServerHandshakeState1.prototype=new ElevatedState,ServerHandshakeState1.prototype.onConnected=function(a){var b=automationMessageFactory.messageToIdFromIdWithPayload(this.machine.getUUID(),TSProtocol.serverId,{handshake:TSProtocol.messages.HS_GET_CLIENT_INFO,serverVersion:TSProtocol.version});return a.sendAutomationMessage(b),new ServerHandshakeState2},ServerHandshakeState1.prototype.onClosed=function(){return new ServerHandshakeRejected},ServerHandshakeState2.prototype=new ElevatedState,ServerHandshakeState2.prototype.beginState=function(a){this._connectionTimeout=setTimeout(function(){a.stop()}.bind(this),this.machine.server.getConnectionTimeout())},ServerHandshakeState2.prototype.endState=function(){clearTimeout(this._connectionTimeout)},ServerHandshakeState2.prototype.handleMessage=function(a,b,c){if(!validation.validateHandshakeResponse(b))return c(automationMessageFactory.errorPayloadWithError(validation.getError())),new ServerHandshakeRejected;if(this.machine.setVersion(parseInt(b.data.version)),this.machine.setPlatformInfo(b.data.platformInfo),this.machine.setCapabilities(b.data.capabilities),this.machine.setIdentity(b.data.identity),this.machine.getIdentity().resumeId){var d=this.machine.server.getConnectionWithUUID(this.machine,this.machine.getIdentity().resumeId);return d?(d.resume(this.machine),this.machine.emit("rejected",this.machine),c({handshake:TSProtocol.messages.HS_ACCEPTED,id:this.machine.getUUID()}),new ServerHandshakeResumed):(c(automationMessageFactory.errorPayloadWithError(TSProtocol.errors.INVALID_RESUME_ID)),new ServerHandshakeRejected)}return-1!==this.machine.getCapabilities().indexOf(TSProtocol.capabilities.AUTOMATION_EXECUTION_AGENT)?(c({handshake:TSProtocol.messages.HS_ACCEPTED,id:this.machine.getUUID()}),new AutomationAgentStates.IdleState):-1!==this.machine.getCapabilities().indexOf(TSProtocol.capabilities.AUTOMATION_TEST_RUNNER)?(c({handshake:TSProtocol.messages.HS_ACCEPTED,id:this.machine.getUUID()}),new AutomationRunnerStates.IdleState):(c(automationMessageFactory.errorPayloadWithError(TSProtocol.errors.HANDSHAKE_FAILED)),ServerHandshakeRejected())},ServerHandshakeState2.prototype.onClosed=function(){return new ServerHandshakeRejected},ServerHandshakeRejected.prototype=new ElevatedState,ServerHandshakeRejected.prototype.beginState=function(a){a.stop(),this.machine.emit("rejected",this.machine)},ServerHandshakeResumed.prototype=new ElevatedState,module.exports={ServerHandshakeState1:ServerHandshakeState1};