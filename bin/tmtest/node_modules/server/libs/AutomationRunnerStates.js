function IdleState(){}function DisconnectAgentsState(a,b){this._agentIds=a,this._sendResponse=b,this._timeout=null,this._awaitingDisconnects=[]}var ElevatedState=require("./AutomationState.js").ElevatedState,automationMessageFactory=require("./automationMessageFactory.js"),logger=require("./logger.js"),TSProtocol=require("./TsAutomationProtocol.js"),NetSocketClientProvider=require("./NetSocketClientProvider.js"),Connection=require("./Connection.js").Connection,AutomationReverseHandshakeStates=require("./AutomationReverseHandshakeStates.js"),validation=require("./Validation.js");IdleState.prototype=new ElevatedState,IdleState.prototype.beginState=function(){this.machine.emit("connected",this.machine)},IdleState.prototype.handleMessage=function(a,b,c){if(!validation.validateIncomingAutomationMessage(b))return a.sendAutomationMessage(b.generateResponseFromIdWithPayload(TSProtocol.serverId,automationMessageFactory.errorPayloadWithError(validation.getError()))),this;if(b.toId===TSProtocol.serverId){var d,e,f;if(b.data.cmd===TSProtocol.commands.GET_CLIENTS_WITH_CAPABILITY){if(logger.debug("Handling get-clients-with-capability command."),!validation.validateArrayElements(b.data.params.capabilities,"string"))return c(automationMessageFactory.errorPayloadWithError(validation.getError())),this;f=this.machine.server.getClientsWithCapabilities(this.machine,b.data.params.capabilities);var g=[];for(var h in f)g.push({id:f[h].getUUID(),platformInfo:f[h].getPlatformInfo(),capabilities:f[h].getCapabilities()});2==this.machine.getVersion()?c(g):c(automationMessageFactory.successPayloadWithCustomParams({clients:g}))}else if(b.data.cmd===TSProtocol.commands.CONNECT_SOCKETS_SERVER){if(logger.debug("Handling connect-sockets-server command."),!(validation.validateAutomationMessageHasParams(b)&&validation.validateArgument(b.data.params.address,"string",!1)&&validation.validateArgument(b.data.params.sharedKey,"string",!1)&&validation.validateArgument(b.data.params.timeout,"number",!1)))return c(automationMessageFactory.errorPayloadWithError(validation.getError())),this;var i=b.data.params.address;d=b.data.params.sharedKey,e=b.data.params.timeout;var j=new NetSocketClientProvider(i,e),k=new AutomationReverseHandshakeStates.ReverseHandshakeState1(d,c),l=new Connection(j,k);this.machine.server.startConnection(l)}else{if(b.data.cmd===TSProtocol.commands.DISCONNECT_AGENTS)return logger.debug("Handling disconnect-agents command."),validation.validateAutomationMessageHasParams(b)&&validation.validateArrayElements(b.data.params.agentIds,"string")?new DisconnectAgentsState(b.data.params.agentIds,c):(c(automationMessageFactory.errorPayloadWithError(validation.getError())),this);c(automationMessageFactory.failurePayloadWithReason("'"+b.data.cmd+"' is not a recognized automation command."))}}else b.fromId=this.machine.getUUID(),this.machine.server.routeMessage(this.machine,b,c);return this},IdleState.prototype.routeMessage=function(a,b){return a.sendAutomationMessage(b),this},IdleState.prototype.onClosed=function(){return this.machine.emit("disconnected",this.machine),this},DisconnectAgentsState.prototype=new ElevatedState,DisconnectAgentsState.prototype.beginState=function(){this._timeout=setTimeout(function(){this._sendResponse(automationMessageFactory.failurePayloadWithReason("Timed out while disconnecting devices."))}.bind(this),8e3);var a,b=[],c=[];for(a in this._agentIds){var d=this.machine.server.getConnectionWithUUID(this.machine,this._agentIds[a]);d?b.push(d):c.push(this._agentIds[a])}if(c.length>0)return clearTimeout(this._timeout),this._sendResponse(automationMessageFactory.failurePayloadWithReason("No agent(s) with ID(s): "+c.toString())),void 0;for(a in b)this._awaitingDisconnects.push(b[a].getUUID()),b[a].stop(!0)},DisconnectAgentsState.prototype.onSiblingDisconnected=function(a,b){var c=this._awaitingDisconnects.indexOf(b.getUUID());c>-1&&this._awaitingDisconnects.splice(c,1),this._awaitingDisconnects.length<=0&&(clearTimeout(this._timeout),this._sendResponse(automationMessageFactory.successPayloadWithReason("Agent(s) successfully disconnected.")))},module.exports={IdleState:IdleState};