function getBuffer(a){var b=new Buffer(4+a.length);return b.writeInt32BE(a.length,0),b.write(a,4),b}function NetSocketClientProvider(a,b){EventEmitter.call(this),this._retryAttempt=0,this._isRetrying=!1,this._address=a,this.defaultTimeout=b,this._isReading=!1,this._bufferLength=0,this._bufferMsg=""}var net=require("net"),EventEmitter=require("events").EventEmitter,util=require("util"),logger=require("./logger.js"),MAX_RETRIES=60,RETRY_DELAY=500;util.inherits(NetSocketClientProvider,EventEmitter),NetSocketClientProvider.prototype.start=function(){if(!this.clientSocket){this.clientSocket=new net.Socket,this.clientSocket.on("data",function(a){var b="";this._isReading?b=a.toString("utf8",0,this._bufferLength):(this._bufferLength=a.readUInt32BE(0)+4,b=a.toString("utf8",4,this._bufferLength),this._isReading=!0),this._bufferMsg+=b,this._bufferLength-=a.length,this._bufferLength<=0&&(this.emit("message",this._bufferMsg),this._bufferLength=0,this._bufferMsg="",this._isReading=!1)}.bind(this)),this.clientSocket.on("close",function(){logger.debug("Sockets connection closed."),this.clientSocket=null,this._isRetrying||this.emit("close"),this._isRetrying=!1}.bind(this)),this.clientSocket.on("connect",function(){logger.debug("Sockets connection connected."),this._retryAttempt=0,this.emit("connect")}.bind(this)),this.clientSocket.on("error",function(a){"ECONNREFUSED"===a.code&&this._retryAttempt<MAX_RETRIES&&(logger.debug("Connection refused... retry attempt: "+this._retryAttempt),this._retryAttempt++,this._isRetrying=!0,setTimeout(function(){this.clientSocket=null,this.start()}.bind(this),RETRY_DELAY))}.bind(this));var a=this._address.split(":"),b=a[0],c=parseInt(a[1]);this.clientSocket.connect(c,b)}},NetSocketClientProvider.prototype.stop=function(){this.clientSocket&&this.clientSocket.end(),this.clientSocket=null},NetSocketClientProvider.prototype.sendMessage=function(a){this.clientSocket&&this.clientSocket.write(getBuffer(a))},module.exports=NetSocketClientProvider;