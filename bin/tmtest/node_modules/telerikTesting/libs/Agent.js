function queryToArray(a){return Array.isArray(a)?a:[a]}function Agent(a,b,c,d){this.type="AGENT",this.clientConnection=a,this.id=b,this.platformInfo=c,this.capabilities=d,this.screenshotsMode=ApiProtocol.screenshotsModes.SCREENSHOT_OPS,this.screenshotsEnabled=!1}var ios=require("./iOSApi.js"),android=require("./AndroidApi.js"),web=require("./WebApi.js"),coreApi=require("./CoreApi.js"),Q=require("./q.js"),ApiProtocol=require("./ApiProtocol.js"),msgFacory=require("./automationMessageFactory.js"),platforms={WEB:"web",IOS:"ios",ANDROID:"android",WP8:"wp8",NODE:"node",ALL:"all"};Agent.prototype={constructor:Agent,version:"1.0",sendMessage:function(a,b){return b=b||{},Q.fcall(function(){var c=Q.defer();if(this.clientConnection.isConnected){this.screenshotsEnabled&&"coreApi.endExecution"!==a.cmd&&this.screenshotsMode===ApiProtocol.screenshotsModes.ALL_OPS&&(a.params||(a.params={}),a.params.screenshot=!0);var d=msgFacory.messageToIdWithPayload(this.id,a);this.clientConnection.sendMessage(d,b.timeout,function(a,b){a?c.reject(a):c.resolve(b)})}else setTimeout(function(){c.reject(ApiProtocol.errors.SOCKET_NOT_CONNECTED)},1);return c.promise}.bind(this))},tryWrapAutomateWeb:function(a,b){if(a.platformKey==platforms.WEB&&"undefined"!=typeof b.message){if(this.platformInfo.platformKey==platforms.IOS)return{message:{cmd:"ios.automateWeb",params:{query:[{"class":"UIWebView"}],webCommand:b.message}}};if(this.platformInfo.platformKey==platforms.ANDROID)return{message:{cmd:"android.automateWeb",params:{query:[{"class":"android.webkit.WebView"}],webCommand:b.message}}};if(this.platformInfo.platformKey==platforms.WP8)return{message:{cmd:"wp8.automateWeb",params:{query:[{"class":"Microsoft.Phone.Controls.WebBrowser"}],webCommand:b.message}}}}return b},normalizeQuery:function(a,b){return b||(this.platformInfo.platformKey==platforms.IOS&&"undefined"==typeof a["class"]?a["class"]="UIView":this.platformInfo.platformKey==platforms.ANDROID&&"undefined"==typeof a["class"]?a["class"]="android.view.View":this.platformInfo.platformKey==platforms.WP8&&"undefined"==typeof a["class"]&&(a["class"]="System.Windows.UIElement")),queryToArray(a)},validatePlatformKey:function(a){return a===platforms.WEB||a===platforms.ALL?!0:a.indexOf(this.platformInfo.platformKey)>-1},getScreenshot:function(a){return void 0!==a.params?a.params.screenshot:void 0},getScreenshotPromise:function(){return this.platformInfo.platformKey==platforms.IOS||this.platformInfo.platformKey==platforms.ANDROID||this.platformInfo.platformKey==platforms.WP8?coreApi.screenshot(this.platformInfo.platformKey,this.platformInfo.platformKey+".screenshot"):null},getEndExecutionPromise:function(){return this.platformInfo.platformKey==platforms.IOS||this.platformInfo.platformKey==platforms.ANDROID||this.platformInfo.platformKey==platforms.WP8?coreApi.endExecution(this.platformInfo.platformKey):null}},module.exports=Agent;