var ApiProtocol=require("./ApiProtocol.js"),api=require("./api.js"),config=require("./config.js"),coreApi=require("./CoreApi.js"),Q=require("./q.js"),ValidateArgument=api.ValidateArgument,ValidateArrayElements=api.ValidateArrayElements,keyCodes={Back:4,Enter:66,Menu:82,Search:84},setTextType={Programmatic:1,SoftwareKeyboard:2,HardwareKeyboard:3},zoomType={ZoomIn:1,ZoomOut:2},DRAG_TOUCH_DELAY=10,MIN_STEPS=3,MAX_STEPS=1e3,MAX_SWIPE_DIRECTION=3,constants={tapType:{center:0,atLocation:1,centerLeft:2,centerRight:3,tapAndHold:4,auto:5},pinchType:{pinchIn:0,pinchOut:1},dragType:{dragToPoint:0,dragToDisplacement:1}},waitForMessageResponse=function(a,b,c,d,e,f){return d.sendMessage(a).then(function(g){return api.isResponseValid(g)?(new Date).getTime()>=e?api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Timeout.")):g.params[b]!=c?Q.delay(f).then(function(){return waitForMessageResponse(a,b,c,d,e,f)}):g.result.code===ApiProtocol.responseCodes.SUCCESS?api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,g.result.reason,d.getScreenshot(g))):api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,g.result.reason,d.getScreenshot(g))):api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Invalid response received from agent."))}).fail(function(a){return api.FAIL(api.createResult(ApiProtocol.resultTypes.EXCEPTION,a))}).then(function(a){return a})},tap=function(a,b,c,d,e,f){return api.createCommand("android",a,function(a){ValidateArgument(b,"object","query",!1);var g={query:a.normalizeQuery(b),tapType:constants.tapType.auto};return ValidateArgument(c,"object","point",!0)&&(ValidateArgument(c.x,"number","point.x",!1),ValidateArgument(c.y,"number","point.y",!1),g.point={x:c.x,y:c.y}),ValidateArgument(d,"number","tapCount",!0,1)&&(g.tapCount=d),ValidateArgument(e,"number","tapDownDelay",!0,1)&&(g.tapDownDelay=e),ValidateArgument(f,"number","tapUpDelay",!0,1)&&(g.tapUpDelay=f),{message:{cmd:"android.tap",params:g}}})},pinch=function(a,b,c,d,e,f){return api.createCommand("android",a,function(a){ValidateArgument(c,"object","query",!1);var g={query:a.normalizeQuery(c),pinchType:b};ValidateArgument(d,"object","point",!0)&&(ValidateArgument(d.x,"number","point.x",!1),ValidateArgument(d.y,"number","point.y",!1),g.point={x:d.x,y:d.y}),ValidateArgument(e,"number","distance",!0,1)&&(g.distance=e);var h=0;return ValidateArgument(f,"number","steps",!0,MIN_STEPS,MAX_STEPS)&&(g.steps=f,h=DRAG_TOUCH_DELAY*f),{message:{cmd:"android.pinch",params:g},options:{timeout:config.messageTimeout+h}}})},drag=function(a,b,c,d,e,f,g){return api.createCommand("android",a,function(a){ValidateArgument(c,"object","query",!1);var h={query:a.normalizeQuery(c),dragType:b};ValidateArgument(d,"object","fromPoint",!0)&&(ValidateArgument(d.x,"number","fromPoint.x",!1),ValidateArgument(d.y,"number","fromPoint.y",!1),h.fromPoint={x:d.x,y:d.y}),ValidateArgument(e,"object",f,!0)&&(ValidateArgument(e.x,"number",f+".x",!1),ValidateArgument(e.y,"number",f+".y",!1),h.toPoint={x:e.x,y:e.y});var i=0;return ValidateArgument(g,"number","steps",!0,MIN_STEPS,MAX_STEPS)&&(h.steps=g,i=DRAG_TOUCH_DELAY*g),{message:{cmd:"android.drag",params:h},options:{timeout:config.messageTimeout+i}}})},androidApi={constants:{swipeDirection:{right:0,left:1,up:2,down:3}},launch:function(a){return api.createCommand("android","android.launch",function(){return ValidateArgument(a,"string","packageName",!1),{message:{cmd:"android.launch",params:{packageName:a}}}})},close:function(){return api.createCommand("android","android.close",function(){return{message:{cmd:"android.close"}}})},wait:function(a){return coreApi.wait("android","android.wait",a)},screenshot:function(){return coreApi.screenshot("android","android.screenshot")},getPropertyValue:function(a,b,c){return api.createCommand("android","android.getPropertyValue",function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","property",!1),ValidateArgument(c,"function","valueCallback",!0),{message:{cmd:"android.getPropertyValue",params:{query:d.normalizeQuery(a),property:b}}}},function(a,b){return c&&c(b.params.value),api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,b.result.reason,a.getScreenshot(b)))})},selectRow:function(a,b,c){return api.createCommand("android","android.selectRow",function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","row",!1),ValidateArgument(c,"number","group",!0),{message:{cmd:"android.selectRow",params:{query:d.normalizeQuery(a),row:b,group:c}}}})},tap:function(a,b,c,d){return tap("android.tap",a,null,b,c,d)},tapAtPoint:function(a,b,c,d,e){return tap("android.tapAtPoint",a,b,c,d,e)},tapAndHold:function(a){return tap("android.tapAndHold",a,null,1,2e3,100)},tapCenterLeft:function(a){return api.createCommand("android","android.tapCenterLeft",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"android.tap",params:{query:b.normalizeQuery(a),tapType:constants.tapType.centerLeft}}}})},tapCenterRight:function(a){return api.createCommand("android","android.tapCenterRight",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"android.tap",params:{query:b.normalizeQuery(a),tapType:constants.tapType.centerRight}}}})},swipe:function(a,b){return api.createCommand("android","android.swipe",function(c){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","direction",!1),0>b||b>MAX_SWIPE_DIRECTION)throw new Error("Invalid direction specified.");return{message:{cmd:"android.swipe",params:{query:c.normalizeQuery(a),direction:b}}}})},pinchIn:function(a,b,c,d){return pinch("android.pinchIn",constants.pinchType.pinchIn,a,b,c,d)},pinchOut:function(a,b,c,d){return pinch("android.pinchOut",constants.pinchType.pinchOut,a,b,c,d)},twoFingerRotate:function(a,b,c){return api.createCommand("android","android.twoFingerRotate",function(d){ValidateArgument(a,"object","query",!1);var e={query:d.normalizeQuery(a)};return ValidateArgument(b,"object","point",!0)&&(ValidateArgument(b.x,"number","point.x",!1),ValidateArgument(b.y,"number","point.y",!1),e.point={x:b.x,y:b.y}),ValidateArgument(c,"number","angleInDegrees",!1),e.angleInDegrees=c,{message:{cmd:"android.rotate",params:e}}})},dragToPoint:function(a,b,c,d){return drag("android.dragToPoint",constants.dragType.dragToPoint,a,b,c,"toPoint",d)},dragToDisplacement:function(a,b,c,d){return drag("android.dragToDisplacement",constants.dragType.dragToDisplacement,a,b,c,"toDisplacement",d)},toggle:function(a,b){return api.createCommand("android","android.toggle",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","toggleValue",!1),{message:{cmd:"android.toggle",params:{query:c.normalizeQuery(a),toggleValue:b}}}})},setDate:function(a,b){return api.createCommand("android","android.setDate",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"object","date",!1),{message:{cmd:"android.setDate",params:{query:c.normalizeQuery(a),date:b.toISOString(),date_local:b.toLocalISOString()}}}})},setText:function(a,b){return api.createCommand("android","android.setText",function(c){return{message:{cmd:"android.setText",params:{query:c.normalizeQuery(a),text:b,type:setTextType.Programmatic}}}})},typeText:function(a,b){return api.createCommand("android","android.typeText",function(c){return{message:{cmd:"android.setText",params:{query:c.normalizeQuery(a),text:b,type:setTextType.SoftwareKeyboard}}}})},pressReturn:function(a){return api.createCommand("android","android.pressReturn",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"android.pressSoftwareKey",params:{query:b.normalizeQuery(a),keyCode:keyCodes.Enter}}}})},pressBackButton:function(){return api.createCommand("android","android.pressBackButton",function(){return{message:{cmd:"android.pressHardwareKey",params:{keyCode:keyCodes.Back}}}})},pressMenuButton:function(){return api.createCommand("android","android.pressMenuButton",function(){return{message:{cmd:"android.pressHardwareKey",params:{keyCode:keyCodes.Menu}}}})},pressSearchButton:function(){return api.createCommand("android","android.pressSearchButton",function(){return{message:{cmd:"android.pressHardwareKey",params:{keyCode:keyCodes.Search}}}})},setValue:function(a,b){return api.createCommand("android","android.setValue",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","value",!1),{message:{cmd:"android.setValue",params:{query:c.normalizeQuery(a),value:b}}}})},zoomIn:function(a){return api.createCommand("android","android.zoom",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"android.zoom",params:{query:b.normalizeQuery(a),zoomType:zoomType.ZoomIn}}}})},zoomOut:function(a){return api.createCommand("android","android.zoom",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"android.zoom",params:{query:b.normalizeQuery(a),zoomType:zoomType.ZoomOut}}}})},automateWeb:function(a,b){return b.postSetup=function(c,d){if("web"!==b.platformKey)throw new Error("Invalid operation. Operation must be a web operation.");return"undefined"!=typeof d.message?{message:{cmd:"android.automateWeb",params:{query:c.normalizeQuery(a),webCommand:d.message}}}:d},b},elementExists:function(a,b){return api.createCommand("android","android.elementExists",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","existsCallback",!1),{message:{cmd:"android.elementExists",params:{query:c.normalizeQuery(a)}}}},function(a,c){return b&&b(c.params.exists),api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,c.result.reason,a.getScreenshot(c)))})},elementVisible:function(a,b){return api.createCommand("android","android.elementVisible",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","visibleCallback",!1),{message:{cmd:"android.elementVisible",params:{query:c.normalizeQuery(a)}}}},function(a,c){return b&&b(c.params.isVisible),api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,c.result.reason,a.getScreenshot(c)))})},waitForElementExists:function(a,b,c,d){return api.createOperation("android","android.waitForElementExists",function(){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","exists",!1),ValidateArgument(c,"number","checkInterval",!1,0),ValidateArgument(d,"number","timeout",!1,0),c>d)throw new Error("Argument checkInterval cannot be greater than argument timeout.");return""},function(){return function(e,f){var g=(new Date).getTime()+d,h={cmd:"android.elementExists",params:{query:f.normalizeQuery(a)}};return waitForMessageResponse(h,"exists",b,f,g,c)}})},waitForElementVisible:function(a,b,c,d){return api.createOperation("android","android.waitForElementVisible",function(){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","visible",!1),ValidateArgument(c,"number","checkInterval",!1,0),ValidateArgument(d,"number","timeout",!1,0),c>d)throw new Error("Argument checkInterval cannot be greater than argument timeout.");return""},function(){return function(e,f){var g=(new Date).getTime()+d,h={cmd:"android.elementVisible",params:{query:f.normalizeQuery(a)}};return waitForMessageResponse(h,"isVisible",b,f,g,c)}})},waitForPropertyValue:function(a,b,c,d,e){return api.createOperation("android","android.waitForPropertyValue",function(){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","property",!1),ValidateArgument(d,"number","checkInterval",!1,0),ValidateArgument(e,"number","timeout",!1,0),d>e)throw new Error("Argument checkInterval cannot be greater than argument timeout.");return""},function(){return function(f,g){var h=(new Date).getTime()+e,i={cmd:"android.getPropertyValue",params:{query:g.normalizeQuery(a),property:b}};return waitForMessageResponse(i,"value",c,g,h,d)}})}};module.exports=androidApi;