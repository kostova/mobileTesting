function AutomationState(){}function ElevatedState(){}function NormalHandshakeState1(a,b,c){this.capabilities=a,this.sharedKey=b,this.resumeId=c}function NormalHandshakeState2(){}function IdleState(a){this.resumeId=a}function ReverseHandshakeState1(a){this.establishConnection=a}function ReverseIdleState(){}var MessageStash=require("./MessageStash.js"),TSProtocol=require("./TsAutomationProtocol.js"),automationMessageFactory=require("./automationMessageFactory.js"),clientInfoFactory=require("./clientInfoFactory.js"),logger=require("./logger.js");AutomationState.prototype={constructor:AutomationState,beginState:function(){},endState:function(){},onConnected:function(){return this},onMessageReceived:function(){return this},sendMessage:function(){return this},onSendMessageTimeout:function(a,b,c){return c({error:{code:100,description:"request timed out."}}),this},onClosed:function(){return this}},ElevatedState.prototype=new AutomationState,ElevatedState.prototype.onMessageReceived=function(a,b){try{var c=automationMessageFactory.messageWithJSONString(b);return this.handleMessage(a,c,function(b){a.sendMessage(c.generateResponseWithPayload(b).toString())})}catch(d){return logger.error("Error: Unable to parse message. Ignoring it."),logger.error(d),this}},ElevatedState.prototype.handleMessage=function(){return this},NormalHandshakeState1.prototype=new ElevatedState,NormalHandshakeState1.prototype.handleMessage=function(a,b,c){if(b.data&&b.data.handshake===TSProtocol.messages.HS_GET_CLIENT_INFO){var d=TSProtocol.MT_PROTOCOL_VERSION_MAX;if(void 0!==b.data.serverVersion){var e=parseInt(b.data.serverVersion);d=e>=TSProtocol.MT_PROTOCOL_VERSION_MIN&&e<=TSProtocol.MT_PROTOCOL_VERSION_MAX?e:TSProtocol.MT_PROTOCOL_VERSION_MAX}else d=TSProtocol.MT_PROTOCOL_VERSION_MIN;this.machine.version=d;var f=clientInfoFactory.create(d);return f.capabilities=this.capabilities,f.identity.sharedKey=f.identity.sharedKey||this.machine.sharedKey,"string"==typeof this.resumeId&&(f.identity.resumeId=this.resumeId),c(f),new NormalHandshakeState2}return this},NormalHandshakeState2.prototype=new ElevatedState,NormalHandshakeState2.prototype.handleMessage=function(a,b){return b.data&&b.data.handshake===TSProtocol.messages.HS_ACCEPTED?new IdleState(b.data.id):(b.data&&b.data.error&&this.machine.emit("error",b.data.error),this)},IdleState.prototype=new ElevatedState,IdleState.prototype.beginState=function(){this.machine.isConnected=!0,this.machine.emit("connected",this.resumeId)},IdleState.prototype.handleMessage=function(a,b,c){var d=MessageStash.pull(b.responseToMessageId),e=d?d.responseCallback:null;if(e){var f=b.toJSON().data;f.error?f.error.code==TSProtocol.errors.RECIPIENT_NOT_AVAILABLE.code?setTimeout(function(){this.sendMessage(a,d.originalMsg,d.originalTimeout,d.responseCallback)}.bind(this),500):e(f):e(null,f)}else b.data&&b.data.cmd?this.machine.emit("message",b,c):logger.error("Got unhandled message! "+b.toString());return this},IdleState.prototype.sendMessage=function(a,b,c,d){return MessageStash.stash(b.messageId,c,d,b),a.sendMessage(b.toString()),this},IdleState.prototype.onClosed=function(){return this.machine.emit("disconnected"),this},ReverseHandshakeState1.prototype=new ElevatedState,ReverseHandshakeState1.prototype.beginState=function(a){this.establishConnection&&a.start()},ReverseHandshakeState1.prototype.onConnected=function(a){var b=automationMessageFactory.messageToIdWithPayload(TSProtocol.serverId,{handshake:TSProtocol.messages.HS_GET_CLIENT_INFO,serverVersion:TSProtocol.version,isResuming:this.establishConnection});return a.sendMessage(b.toString()),this},ReverseHandshakeState1.prototype.handleMessage=function(a,b){this.machine.clientInfo=b.toJSON(),this.machine.version=this.machine.clientInfo.data.version;var c=automationMessageFactory.messageToIdWithPayload(TSProtocol.serverId,{handshake:TSProtocol.messages.HS_ACCEPTED,id:TSProtocol.serverId});return a.sendMessage(c.toString()),new ReverseIdleState},ReverseHandshakeState1.prototype.sendMessage=function(a,b,c,d){return d&&d(automationMessageFactory.errorPayloadWithError(TSProtocol.errors.RECIPIENT_NOT_FOUND)),this},ReverseHandshakeState1.prototype.onSendMessageTimeout=function(a,b,c){return this.establishConnection=!1,a.stop(),c(automationMessageFactory.errorPayloadWithError(TSProtocol.errors.TIMEOUT)),this},ReverseHandshakeState1.prototype.onClosed=function(a){return this.establishConnection&&setTimeout(function(){logger.debug("Handshake unsuccessful... Retrying..."),a.start()},100),this},ReverseIdleState.prototype=new ElevatedState,ReverseIdleState.prototype.beginState=function(){this.retryConnectOnClose=!1,this.machine.isConnected=!0,this.machine.emit("connected")},ReverseIdleState.prototype.handleMessage=function(a,b,c){if(b.toId===TSProtocol.serverId&&b.data&&b.data.cmd&&"suspend"===b.data.cmd)return this.retryConnectOnClose=!0,this;this.retryConnectOnClose=!1;var d=MessageStash.pull(b.responseToMessageId),e=d?d.responseCallback:null;return e?e(null,b.toJSON().data):b.data&&b.data.cmd?this.machine.emit("message",b,c):logger.error("Got unhandled message!"+b.toString()),this},ReverseIdleState.prototype.sendMessage=function(a,b,c,d){return 2==this.machine.version&&("ios.launch"===b.data.cmd||"coreApi.endExecution"===b.data.cmd)&&(this.retryConnectOnClose=!0),MessageStash.stash(b.messageId,c,d,b),a.sendMessage(b.toString()),this},ReverseIdleState.prototype.onClosed=function(a){return a.stop(),new ReverseHandshakeState1(this.retryConnectOnClose)},module.exports={AutomationState:AutomationState,ElevatedState:ElevatedState,NormalHandshakeStart:NormalHandshakeState1,ReverseHandshakeStart:ReverseHandshakeState1};