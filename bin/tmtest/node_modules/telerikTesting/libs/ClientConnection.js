function ClientConnection(){EventEmitter.call(this),this.isStarted=!1,this.version=TSProtocol.version}var EventEmitter=require("./EventEmitter.js"),messageStash=require("./MessageStash.js"),TSProtocol=require("./TsAutomationProtocol.js");ClientConnection.prototype._provider=null,ClientConnection.prototype._startState=null,ClientConnection.prototype.sharedKey=null,ClientConnection.prototype.transitionToState=function(a){a&&this._state!==a&&(this._state&&(this._state.endState(this._provider),this._state.machine=null),this._state=a,this._state.machine=this,this._state.beginState(this._provider))},ClientConnection.prototype.start=function(a,b,c){this.isStarted||(this.isStarted=!0,this.sharedKey=c,this._provider=a,messageStash.start(function(a,b){this.isStarted&&this._state&&this.transitionToState(this._state.onSendMessageTimeout(this._provider,a,b))}.bind(this)),a.on("connect",function(){this.isStarted&&this._state&&this.transitionToState(this._state.onConnected(this._provider))}.bind(this)),a.on("message",function(a){this.isStarted&&this._state&&this.transitionToState(this._state.onMessageReceived(this._provider,a))}.bind(this)),a.on("close",function(){this.isStarted&&this._state&&this.transitionToState(this._state.onClosed(this._provider))}.bind(this)),this.transitionToState(b),a.start())},ClientConnection.prototype.stop=function(){this.isStarted&&(this.isStarted=!1,this._state.machine=null,this._state=null,messageStash.stop(),this._provider.stop(),this._provider=null)},ClientConnection.prototype.sendMessage=function(a,b,c){if(!this._provider)throw new Error("attempted to send a message with no active provider.");if(!this._state)throw new Error("attempted to send a message with no active state.");if(b&&"number"!=typeof b)throw new Error("timeout must be a number");b||(b=this._provider.defaultTimeout),this.transitionToState(this._state.sendMessage(this._provider,a,b,c))},module.exports=ClientConnection;