function executeItem(a,b,c,d){var e=Q.defer(),f=d,g=[],h=!0,i=!1,j=(new Date).getTime(),k=null,l=null;if(c.type===ApiProtocol.itemTypes.AGENT)try{a.emit("agentExecutionStarted",b,j)}catch(m){logger.error("EM EMITTER ERROR - agentExecutionStarted",m)}else try{a.emit("executionStarted",b,c,j)}catch(m){logger.error("EM EMITTER ERROR - executionStarted",m)}if(c.type===ApiProtocol.itemTypes.OPERATION){if(f){k=(new Date).getTime(),l=api.SKIP(a.builder.skip(b,c,j,k,api.createResult(ApiProtocol.resultTypes.REASON,"Skipped.")),i);try{a.emit("executionEnded",b,c,k,l.outputResult)}catch(m){logger.error("EM EMITTER ERROR - executionEnded",m)}return l}return Q.spread([a,b],c.operation.execute.bind(c.operation)).then(function(d){if(k=(new Date).getTime(),d.isPass())d=api.PASS(a.builder.pass(b,c,j,k,d.outputResult),i);else if(d.isSkip())d=api.SKIP(a.builder.skip(b,c,j,k,d.outputResult),i);else if(d.isFail()){if(d.isFailAndCannotContinue())try{a.emit("executionError",b,c,ApiProtocol.errors.EM_AGENT_DISCONNECTED)}catch(e){logger.error("EM EMITTER ERROR - executionError",e)}if(b.screenshotsMode===ApiProtocol.screenshotsModes.FAILED_OPS){var f=b.getScreenshotPromise();if(f)return Q.spread([a,b],f.execute.bind(f)).then(function(e){e.isPass()?(d.outputResult.screenshot=e.outputResult.screenshot,d=api.FAIL(a.builder.fail(b,c,j,k,d.outputResult),d.isFailAndCannotContinue())):d=api.FAIL(a.builder.fail(b,c,j,k,d.outputResult),d.isFailAndCannotContinue());try{a.emit("executionEnded",b,c,k,d.outputResult)}catch(f){logger.error("EM EMITTER ERROR - executionEnded",f)}return d})}d=api.FAIL(a.builder.fail(b,c,j,k,d.outputResult),d.isFailAndCannotContinue())}try{a.emit("executionEnded",b,c,k,d.outputResult)}catch(e){logger.error("EM EMITTER ERROR - executionEnded",e)}return d})}return Q(c.getChildren(b)).then(function(m){return m.length<=0&&(d=!0),m.forEach(function(c){e.promise=e.promise.then(function(){return Q.spread([a,b,c,f],executeItem)}).then(function(d){if(g.push(d.outputResult),(d.stopTestRun||a._isCancelled)&&(f=!0,i=!0),d.isFail()&&(h=!1),c.type===ApiProtocol.itemTypes.OPERATION)f||(f=d.isFail());else if(c.type===ApiProtocol.itemTypes.STEP)f||(f=d.isFail());else if(c.type===ApiProtocol.itemTypes.TEST&&!f){var e=b.getEndExecutionPromise();if(e)return Q.spread([a,b],e.execute.bind(e)).then(function(d){if(d.isFail()){f=!0,i=!0;try{a.emit("executionError",b,c,ApiProtocol.errors.EM_END_EXECUTION_FAILED)}catch(e){logger.error("EM EMITTER ERROR - executionError",e)}}})}}).fail(function(a){throw logger.error(c.type+" - Unhandled Error: ",a),a})}),e.resolve(),e.promise.then(function(){if(k=(new Date).getTime(),l=d?api.SKIP(a.builder.skipWithResults(b,c,j,k,g),i):h?api.PASS(a.builder.passWithResults(b,c,j,k,g),i):api.FAIL(a.builder.failWithResults(b,c,j,k,g),i),c.type===ApiProtocol.itemTypes.AGENT)try{a.emit("agentExecutionEnded",b,k)}catch(e){logger.error("EM EMITTER ERROR - agentExecutionEnded",e)}else try{a.emit("executionEnded",b,c,k,l.outputResult)}catch(e){logger.error("EM EMITTER ERROR - executionEnded",e)}return l})})}function executeSuitesOnAgents(a,b,c){var d=Q.defer(),e=[];return c.forEach(function(c){var d=new api.TSNode(ApiProtocol.itemTypes.AGENT,c.id);d.agent=c,d.children=b;var f=Q().then(function(){return Q.spread([a,c,d,!1],executeItem)}).fail(function(a){throw logger.error("AGENT - Unhandled Error: ",a),a}).then(function(b){if(a._isCancelled){var d=c.getEndExecutionPromise();if(d)return Q.spread([a,c],d.execute.bind(d)).then(function(d){if(d.isFail())try{a.emit("executionError",c,c,ApiProtocol.errors.EM_END_EXECUTION_FAILED)}catch(e){logger.error("EM EMITTER ERROR - executionError",e)}return b})}return b});e.push(f)}),d.resolve(e),d.promise.then(function(a){return Q.allSettled(a).then(function(a){var b=Q.defer(),c=[];return a.forEach(function(a){if("fulfilled"!==a.state)throw a;c.push(a.value.outputResult)}),b.resolve(c),b.promise})})}function ExecutionManagerResultBuilder(a){this.impl=a}function ExecutionManager(){this._reporterImpl=null,this._builderImpl=null,this._isExecuting=!1,this._isCancelled=!1,EventEmitter.call(this)}var Q=require("./q.js"),EventEmitter=require("./EventEmitter.js"),api=require("./api.js"),ApiProtocol=require("./ApiProtocol.js"),logger=require("./logger.js");ExecutionManagerResultBuilder.prototype={constructor:ExecutionManagerResultBuilder,pass:function(a,b,c,d,e){try{return this.impl.pass(a,b,c,d,e)}catch(f){return logger.error("RB ERROR - pass: ",f),"RB ERROR: pass"}},skip:function(a,b,c,d,e){try{return this.impl.skip(a,b,c,d,e)}catch(f){return logger.error("RB ERROR - skip: ",f),"RB ERROR: skip"}},fail:function(a,b,c,d,e){try{return this.impl.fail(a,b,c,d,e)}catch(f){return logger.error("RB ERROR - fail: ",f),"RB ERROR: fail"}},passWithResults:function(a,b,c,d,e){try{return this.impl.passWithResults(a,b,c,d,e)}catch(f){return logger.error("RB ERROR - passWithResults: ",f),"RB ERROR: passWithResults"}},skipWithResults:function(a,b,c,d,e){try{return this.impl.skipWithResults(a,b,c,d,e)}catch(f){return logger.error("RB ERROR - skipWithResults: ",f),"RB ERROR: skipWithResults"}},failWithResults:function(a,b,c,d,e){try{return this.impl.failWithResults(a,b,c,d,e)}catch(f){return logger.error("RB ERROR - failWithResults: ",f),"RB ERROR: failWithResults"}}},ExecutionManager.prototype={constructor:ExecutionManager,setBuilder:function(a){this._builderImpl=a,this.builder=new ExecutionManagerResultBuilder(a)},executeSuitesOnAgents:function(a,b,c){var d=this;return d._isExecuting?(c&&"function"==typeof c&&c(ApiProtocol.errors.EM_ALREADY_EXECUTING,null),void 0):(d._isExecuting=!0,Q.spread([this,a,b],executeSuitesOnAgents).then(function(a){d._isExecuting=!1,d._isCancelled=!1,c&&"function"==typeof c&&c(null,a)}).fail(function(a){logger.error("EXECUTION MANAGER - Unhandled Error: ",a),d._isExecuting=!1,d._isCancelled=!1,c&&"function"==typeof c&&c(ApiProtocol.errors.EM_UNHANDLED_EXCEPTION.customize(a),null)}).done())},executeOperationOnAgent:function(a,b,c){var d=this;return d._isExecuting?(c&&"function"==typeof c&&c(ApiProtocol.errors.EM_ALREADY_EXECUTING,null),void 0):(d._isExecuting=!0,Q.spread([this,b,a,!1],executeItem).then(function(a){d._isExecuting=!1,d._isCancelled=!1,c&&"function"==typeof c&&c(null,a)}).fail(function(a){logger.error("EXECUTION MANAGER - Unhandled Error: ",a),d._isExecuting=!1,d._isCancelled=!1,c&&"function"==typeof c&&c(ApiProtocol.errors.EM_UNHANDLED_EXCEPTION.customize(a),null)}).done())},cancelExecution:function(){this._isExecuting&&(this._isCancelled=!0)}},module.exports=ExecutionManager;