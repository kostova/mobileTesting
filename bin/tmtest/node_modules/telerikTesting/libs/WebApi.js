function NormalizeString(a){return"string"!=typeof a?a:a.replace(/"/g,"'")}function ApplyLocalhostAlias(a){if(localhostAlias)for(var b=["localhost","http://localhost","https://localhost"],c=0;c<b.length;c++)if(0===a.indexOf(b[c])){a=b[c].replace("localhost",localhostAlias)+a.substring(b[c].length,a.length);break}return a}function AddToPromiseChain(a,b,c,d,e,f){return api.createCommand("web",a,function(a){return f&&f(),{message:{cmd:b,params:c(a)}}},function(a,b){if(d){var c=e(b,a);d.apply(this,c)}return api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,b.result.reason,a.getScreenshot(b)))})}function AddToPromiseChainAndWait(a,b,c,d,e,f,g){return api.createOperation("web",a,function(a){return g&&g(),{message:{cmd:b,params:c(a)}}},function(a){return function(b,c){return c.sendMessage(a.message).then(function(a){if(api.isResponseValid(a)){if(a.result.code===ApiProtocol.responseCodes.SUCCESS){try{if(d){var b=e(a,c);d.apply(this,b)}}catch(f){return api.FAIL(api.createResult(ApiProtocol.resultTypes.EXCEPTION,f,c.getScreenshot(a)))}return api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,a.result.reason,c.getScreenshot(a)))}return api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,a.result.reason,c.getScreenshot(a)))}return api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Invalid response receieved from agent."))}).fail(function(a){return api.FAIL(api.createResult(ApiProtocol.resultTypes.EXCEPTION,a))}).then(function(a){return a.isFailAndCannotContinue()?a:Q.delay(f).then(function(){return a})})}})}function WaitForScriptResult(a,b,c,d,e,f,g){return d.sendMessage({cmd:"web.executeScript",params:{script:a,query:d.normalizeQuery(b,!0),getResult:!0}}).then(function(h){return api.isResponseValid(h)?(new Date).getTime()>=e?api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Call timed out.")):h.params.scriptResult!=c?Q.delay(g).then(function(){return WaitForScriptResult(a,b,c,d,e,f,g)}):h.result.code===ApiProtocol.responseCodes.SUCCESS?api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,h.result.reason,d.getScreenshot(h))):api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,h.result.reason,d.getScreenshot(h))):api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Invalid response receieved from agent."))}).fail(function(a){return api.FAIL(api.createResult(ApiProtocol.resultTypes.EXCEPTION,a))}).then(function(a){return a})}function ExecuteDepotScript(a,b,c,d){return api.createCommand("web",a,function(a){var d=scriptDepotFactory.getDepot(a.platformInfo.browser),e=b(d);return{message:{cmd:"web.executeScript",params:{script:e,query:a.normalizeQuery(c,!0),getResult:!0}}}},function(a,b){return d&&d(b.params.scriptResult,a.platformInfo.browser),api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,b.result.reason,a.getScreenshot(b)))})}function ExecuteDepotScriptAndWait(a,b,c,d,e){return api.createOperation("web",a,function(a){var d=scriptDepotFactory.getDepot(a.platformInfo.browser),e=b(d);return{message:{cmd:"web.executeScript",params:{script:e,query:a.normalizeQuery(c,!0),getResult:!0}}}},function(a){return function(b,c){return c.sendMessage(a.message).then(function(a){if(api.isResponseValid(a)){if(a.result.code===ApiProtocol.responseCodes.SUCCESS){try{d&&d(a.params.scriptResult,c.platformInfo.browser)}catch(b){return api.FAIL(api.createResult(ApiProtocol.resultTypes.EXCEPTION,b,c.getScreenshot(a)))}return api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,a.result.reason,c.getScreenshot(a)))}return api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,a.result.reason,c.getScreenshot(a)))}return api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Invalid response receieved from agent."))}).fail(function(a){return api.FAIL(api.createResult(ApiProtocol.resultTypes.EXCEPTION,a))}).then(function(a){return a.isFailAndCannotContinue()?a:Q.delay(e).then(function(){return a})})}})}var NAVIGATE_TIMEOUT=1e3,DEFAULT_CHECK_INTERVAL=100,scriptDepotFactory=require("./ScriptDepotFactory.js"),api=require("./api.js"),coreApi=require("./CoreApi.js"),ApiProtocol=require("./ApiProtocol.js"),WebApiProtocol=require("./WebApiProtocol.js"),Q=require("./q.js"),localhostAlias=null,ValidateArgument=api.ValidateArgument,ValidateArrayElements=api.ValidateArrayElements,webApi={prepareDomain:function(a){return AddToPromiseChainAndWait("web.prepareDomain","web.prepareDomain",function(){var b=ApplyLocalhostAlias(a);return{url:b}},null,null,NAVIGATE_TIMEOUT,function(){ValidateArgument(a,"string","url",!1)})},navigateToUrl:function(a){var b=function(b){ValidateArgument(a,"string","url",!1);var c=ApplyLocalhostAlias(a);return b.navigateToUrl(c)};return ExecuteDepotScriptAndWait("web.navigateToUrl",b,null,null,NAVIGATE_TIMEOUT)},executeScript:function(a,b,c){return AddToPromiseChain("web.executeScript","web.executeScript",function(d){return c?{script:a,query:d.normalizeQuery(b,!0),getResult:!0}:{script:a,query:d.normalizeQuery(b,!0)}},c,function(a,b){return[a.params.scriptResult,b.platformInfo.browser]},function(){ValidateArgument(a,"string","script",!1),ValidateArgument(b,"object","query",!0),ValidateArgument(c,"function","callback",!0)})},getScriptResult:function(a,b,c){return AddToPromiseChain("web.getScriptResult","web.executeScript",function(c){return{script:a,query:c.normalizeQuery(b,!0),getResult:!0}},c,function(a,b){return[a.params.scriptResult,b.platformInfo.browser]},function(){ValidateArgument(a,"string","script",!1),ValidateArgument(b,"object","query",!0),ValidateArgument(c,"function","callback",!0)})},wait:function(a){return coreApi.wait("web","web.wait",a)},screenshot:function(){return coreApi.screenshot("ios;android","web.screenshot")},waitForScriptResult:function(a,b,c,d,e){return api.createOperation("web","web.waitForScriptResult",function(){return ValidateArgument(a,"string","script",!1),ValidateArgument(b,"object","query",!0),ValidateArgument(d,"number","timeout",!1),ValidateArgument(e,"number","checkInterval",!0),""},function(){return function(f,g){var h=(new Date).getTime()+d;return WaitForScriptResult(a,b,c,g,h,null,e||DEFAULT_CHECK_INTERVAL)}})},waitForUrl:function(a,b,c){return api.createOperation("web","web.waitForUrl",function(){return ValidateArgument(a,"string","url",!1),ValidateArgument(b,"number","timeout",!0),ValidateArgument(c,"number","checkInterval",!0),""},function(){return function(d,e){var f=ApplyLocalhostAlias(a),g=scriptDepotFactory.getDepot(e.platformInfo.browser),h=g.getUrl,i=(new Date).getTime()+b;return WaitForScriptResult(h,null,f,e,i,null,c||DEFAULT_CHECK_INTERVAL)}})},click:function(a){var b=function(b){return ValidateArgument(a,"object","query",!1),b.click};return ExecuteDepotScript("web.click",b,a,null)},tap:function(a){var b=function(b){return ValidateArgument(a,"object","query",!1),b.tap};return ExecuteDepotScript("web.tap",b,a,null)},doubleClick:function(a){var b=function(b){return ValidateArgument(a,"object","query",!1),b.doubleClick};return ExecuteDepotScript("web.doubleClick",b,a,null)},rightClick:function(a){var b=function(b){return ValidateArgument(a,"object","query",!1),b.rightClick};return ExecuteDepotScript("web.rightClick",b,a,null)},drag:function(a,b,c){var d=function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","offsetX",!1),ValidateArgument(c,"number","offsetY",!1),d.dragElement(b,c)};return ExecuteDepotScript("web.drag",d,a,null)},dragToElement:function(a,b){var c=function(c){return ValidateArgument(a,"object","dragElementQuery",!1),ValidateArgument(b,"object","toElementQuery",!1),c.dragElementToElement(b)};return ExecuteDepotScript("web.dragToElement",c,a,null)},hoverOver:function(a){var b=function(b){return ValidateArgument(a,"object","query",!1),b.hoverOver};return ExecuteDepotScript("web.hoverOver",b,a,null)},pressKey:function(a,b,c,d,e){var f=function(f){return ValidateArgument(a,"object","query",!1),"string"==typeof b&&(b=b.charCodeAt(0)),ValidateArgument(b,"number","keyCode",!1),ValidateArgument(c,"boolean","alt",!0),c=c?!0:!1,ValidateArgument(d,"boolean","ctrl",!0),d=d?!0:!1,ValidateArgument(e,"boolean","shift",!0),e=e?!0:!1,f.pressKey(b,c,d,e)};return ExecuteDepotScript("web.pressKey",f,a,null)},getAttribute:function(a,b,c){var d=function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","attrName",!1),ValidateArgument(c,"function","callback",!0),d.getAttribute(b)};return ExecuteDepotScript("web.getAttribute",d,a,c)},setAttribute:function(a,b,c){var d=function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","attrName",!1),ValidateArgument(c,"string","attrValue",!1),d.setAttribute(b,NormalizeString(c))};return ExecuteDepotScript("web.setAttribute",d,a,null)},getStyle:function(a,b,c){var d=function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","styleProp",!1),ValidateArgument(c,"function","callback",!0),d.getStyle(b)};return ExecuteDepotScript("web.getStyle",d,a,c)},setStyle:function(a,b,c){var d=function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","styleProp",!1),ValidateArgument(c,"string","styleValue",!1),d.setStyle(b,c)};return ExecuteDepotScript("web.setStyle",d,a,null)},getTextContent:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getTextContent};return ExecuteDepotScript("web.getTextContent",c,a,b)},setTextContent:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","textContentValue",!1),c.setTextContent(NormalizeString(b))};return ExecuteDepotScript("web.setTextContent",c,a,null)},getValue:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getValue};return ExecuteDepotScript("web.getValue",c,a,b)},setValue:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","value",!1),c.setValue(NormalizeString(b))};return ExecuteDepotScript("web.setValue",c,a,null)},getHtml:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getHtml};return ExecuteDepotScript("web.getHtml",c,a,b)},setHtml:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","content",!1),c.setHtml(NormalizeString(b))};return ExecuteDepotScript("web.setHtml",c,a,null)},getChecked:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getChecked};return ExecuteDepotScript("web.getChecked",c,a,b)},setChecked:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","checkedValue",!1),c.setChecked(b)};return ExecuteDepotScript("web.setChecked",c,a,null)},getRowsCount:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getRowsCount};return ExecuteDepotScript("web.getRowsCount",c,a,b)},getColumnsCount:function(a,b,c){var d=function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","rowIndex",!1),ValidateArgument(c,"function","callback",!0),d.getColumnsCount(b)};return ExecuteDepotScript("web.getColumnsCount",d,a,c)},getSelectedIndex:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getSelectedIndex};return ExecuteDepotScript("web.getSelectedIndex",c,a,b)},setSelectedIndex:function(a,b){var c=function(c){ValidateArgument(a,"object","query",!1),Array.isArray(b)||(ValidateArgument(b,"number","index",!1),b=[b]),ValidateArrayElements(b,"number","index");var d="["+b.toString()+"]";return c.setSelectedIndex(d)};return ExecuteDepotScript("web.setSelectedIndex",c,a,null)},getSelectedText:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getSelectedText};return ExecuteDepotScript("web.getSelectedText",c,a,b)},setSelectedText:function(a,b){var c=function(c){ValidateArgument(a,"object","query",!1),Array.isArray(b)||(ValidateArgument(b,"string","text",!1),b=[b]),ValidateArrayElements(b,"string","text");for(var d="[",e=0;e<b.length;e++)d+='"'+NormalizeString(b[e])+'",';return d+="]",c.setSelectedText(d)};return ExecuteDepotScript("web.setSelectedText",c,a,null)},getSelectedValue:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getSelectedValue};return ExecuteDepotScript("web.getSelectedValue",c,a,b)},setSelectedValue:function(a,b){var c=function(c){ValidateArgument(a,"object","query",!1),Array.isArray(b)||(ValidateArgument(b,"string","selValue",!1),b=[b]),ValidateArrayElements(b,"string","selValue");for(var d="[",e=0;e<b.length;e++)d+='"'+NormalizeString(b[e])+'",';return d+="]",c.setSelectedValue(d)};return ExecuteDepotScript("web.setSelectedValue",c,a,null)},getPaused:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getPaused};return ExecuteDepotScript("web.getPaused",c,a,b)},setPaused:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","pausedState",!1),c.setPaused(b)};return ExecuteDepotScript("web.setPaused",c,a,null)},getInError:function(a,b){var c=function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","callback",!0),c.getInError};return ExecuteDepotScript("web.getInError",c,a,b)},dialogs:{ALERT:WebApiProtocol.dialogs.ALERT,CONFIRM:WebApiProtocol.dialogs.CONFIRM,PROMPT:WebApiProtocol.dialogs.PROMPT,prepare:function(a,b){return AddToPromiseChain("web.dialogs.prepare","web.dialogs.prepare",function(){return{key:a,options:b}},null,null,function(){ValidateArgument(a,"string","key",!1),ValidateArgument(b,"object","options",!0)})},getState:function(a){return AddToPromiseChain("web.dialogs.getState","web.dialogs.getState",function(){return null},a,function(a,b){return[a.params.dialogsState,b.platformInfo.browser]},function(){ValidateArgument(a,"function","callback",!0)})}}};Object.defineProperty(webApi,"localhostAlias",{get:function(){return localhostAlias},set:function(a){localhostAlias=a}}),module.exports=webApi;