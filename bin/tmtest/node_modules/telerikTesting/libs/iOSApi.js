var api=require("./api.js"),config=require("./config.js"),ApiProtocol=require("./ApiProtocol.js"),coreApi=require("./CoreApi.js"),Q=require("./q.js"),ValidateArgument=api.ValidateArgument,ValidateArrayElements=api.ValidateArrayElements,DRAG_TOUCH_DELAY=10,MIN_STEPS=3,MAX_STEPS=1e3,MAX_SWIPE_DIRECTION=3,constants={tapType:{center:0,atLocation:1,centerLeft:2,centerRight:3,tapAndHold:4,auto:5},keyType:{none:0,"return":1,enter:2,dismiss:3},pinchType:{pinchIn:0,pinchOut:1},dragType:{dragToPoint:0,dragToDisplacement:1}},tap=function(a,b,c,d,e,f){return api.createCommand("ios",a,function(a){ValidateArgument(b,"object","query",!1);var g={query:a.normalizeQuery(b),tapType:constants.tapType.auto};return ValidateArgument(c,"object","point",!0)&&(ValidateArgument(c.x,"number","point.x",!1),ValidateArgument(c.y,"number","point.y",!1),g.point={x:c.x,y:c.y}),ValidateArgument(d,"number","tapCount",!0,1)&&(g.tapCount=d),ValidateArgument(e,"number","tapDownDelay",!0,1)&&(g.tapDownDelay=e),ValidateArgument(f,"number","tapUpDelay",!0,1)&&(g.tapUpDelay=f),{message:{cmd:"ios.tap",params:g}}})},pinch=function(a,b,c,d,e,f){return api.createCommand("ios",a,function(a){ValidateArgument(c,"object","query",!1);var g={query:a.normalizeQuery(c),pinchType:b};ValidateArgument(d,"object","point",!0)&&(ValidateArgument(d.x,"number","point.x",!1),ValidateArgument(d.y,"number","point.y",!1),g.point={x:d.x,y:d.y}),ValidateArgument(e,"number","distance",!0,1)&&(g.distance=e);var h=0;return ValidateArgument(f,"number","steps",!0,MIN_STEPS,MAX_STEPS)&&(g.steps=f,h=DRAG_TOUCH_DELAY*f),{message:{cmd:"ios.pinch",params:g},options:{timeout:config.messageTimeout+h}}})},drag=function(a,b,c,d,e,f,g){return api.createCommand("ios",a,function(a){ValidateArgument(c,"object","query",!1);var h={query:a.normalizeQuery(c),dragType:b};ValidateArgument(d,"object","fromPoint",!0)&&(ValidateArgument(d.x,"number","fromPoint.x",!1),ValidateArgument(d.y,"number","fromPoint.y",!1),h.fromPoint={x:d.x,y:d.y}),ValidateArgument(e,"object",f,!0)&&(ValidateArgument(e.x,"number",f+".x",!1),ValidateArgument(e.y,"number",f+".y",!1),h.toPoint={x:e.x,y:e.y});var i=0;return ValidateArgument(g,"number","steps",!0,MIN_STEPS,MAX_STEPS)&&(h.steps=g,i=DRAG_TOUCH_DELAY*g),{message:{cmd:"ios.drag",params:h},options:{timeout:config.messageTimeout+i}}})},waitForMessageResponse=function(a,b,c,d,e,f){return d.sendMessage(a).then(function(g){return api.isResponseValid(g)?(new Date).getTime()>=e?api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Timeout.")):g.params[b]!=c?Q.delay(f).then(function(){return waitForMessageResponse(a,b,c,d,e,f)}):g.result.code===ApiProtocol.responseCodes.SUCCESS?api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,g.result.reason,d.getScreenshot(g))):api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,g.result.reason,d.getScreenshot(g))):api.FAIL(api.createResult(ApiProtocol.resultTypes.REASON,"Invalid response received from agent."))}).fail(function(a){return api.FAIL(api.createResult(ApiProtocol.resultTypes.EXCEPTION,a))}).then(function(a){return a})},iOSApi={constants:{tableViewScrollPosition:{none:0,top:1,middle:2,bottom:3},collectionViewScrollPosition:{none:0,top:1,centeredVertically:2,bottom:4,left:8,centeredHorizontally:16,right:32},swipeDirection:{right:0,left:1,up:2,down:3}},launch:function(a){return api.createCommand("ios","ios.launch",function(){return ValidateArgument(a,"string","url",!1),{message:{cmd:"ios.launch",params:{url:a}}}})},close:function(){return api.createCommand("ios","ios.close",function(){return{message:{cmd:"ios.close"}}})},wait:function(a){return coreApi.wait("ios","ios.wait",a)},screenshot:function(){return coreApi.screenshot("ios","ios.screenshot")},getPropertyValue:function(a,b,c){return api.createCommand("ios","ios.getPropertyValue",function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","property",!1),ValidateArgument(c,"function","valueCallback",!1),{message:{cmd:"ios.getValue",params:{query:d.normalizeQuery(a),property:b}}}},function(a,b){return c&&c(b.params.value),api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,b.result.reason,a.getScreenshot(b)))})},elementExists:function(a,b){return api.createCommand("ios","ios.elementExists",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","existsCallback",!1),{message:{cmd:"ios.elementExists",params:{query:c.normalizeQuery(a)}}}},function(a,c){return b&&b(c.params.exists),api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,c.result.reason,a.getScreenshot(c)))})},elementVisible:function(a,b){return api.createCommand("ios","ios.elementVisible",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"function","visibleCallback",!1),{message:{cmd:"ios.elementVisible",params:{query:c.normalizeQuery(a)}}}},function(a,c){return b&&b(c.params.isVisible),api.PASS(api.createResult(ApiProtocol.resultTypes.REASON,c.result.reason,a.getScreenshot(c)))})},tap:function(a,b,c,d){return tap("ios.tap",a,null,b,c,d)},tapAtPoint:function(a,b,c,d,e){return tap("ios.tapAtPoint",a,b,c,d,e)},tapAtLocation:function(a,b,c){return api.createCommand("ios","ios.tapAtLocation",function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","x",!1),ValidateArgument(c,"number","y",!1),{message:{cmd:"ios.tap",params:{query:d.normalizeQuery(a),tapType:constants.tapType.atLocation,point:{x:b,y:c}}}}})},tapAndHold:function(a){return api.createCommand("ios","ios.tapAndHold",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"ios.tap",params:{query:b.normalizeQuery(a),tapType:constants.tapType.tapAndHold}}}})},tapCenterLeft:function(a){return api.createCommand("ios","ios.tapCenterLeft",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"ios.tap",params:{query:b.normalizeQuery(a),tapType:constants.tapType.centerLeft}}}})},tapCenterRight:function(a){return api.createCommand("ios","ios.tapCenterRight",function(b){return ValidateArgument(a,"object","query",!1),{message:{cmd:"ios.tap",params:{query:b.normalizeQuery(a),tapType:constants.tapType.centerRight}}}})},tapSubviewAtIndex:function(a,b){return api.createCommand("ios","ios.tapSubviewAtIndex",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","index",!1,0),{message:{cmd:"ios.selectionItem.select",params:{query:c.normalizeQuery(a),index:b}}}})},swipe:function(a,b){return api.createCommand("ios","ios.swipe",function(c){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","direction",!1),0>b||b>MAX_SWIPE_DIRECTION)throw new Error("Invalid direction specified.");return{message:{cmd:"ios.swipe",params:{query:c.normalizeQuery(a),direction:b}}}})},pinchIn:function(a,b,c,d){return pinch("ios.pinchIn",constants.pinchType.pinchIn,a,b,c,d)},pinchOut:function(a,b,c,d){return pinch("ios.pinchOut",constants.pinchType.pinchOut,a,b,c,d)},twoFingerRotate:function(a,b,c){return api.createCommand("ios","ios.twoFingerRotate",function(d){ValidateArgument(a,"object","query",!1);var e={query:d.normalizeQuery(a)};return ValidateArgument(b,"object","point",!0)&&(ValidateArgument(b.x,"number","point.x",!1),ValidateArgument(b.y,"number","point.y",!1),e.point={x:b.x,y:b.y}),ValidateArgument(c,"number","angleInDegrees",!1),e.angleInDegrees=c,{message:{cmd:"ios.rotate",params:e}}})},dragToPoint:function(a,b,c,d){return drag("ios.dragToPoint",constants.dragType.dragToPoint,a,b,c,"toPoint",d)},dragToDisplacement:function(a,b,c,d){return drag("ios.dragToDisplacement",constants.dragType.dragToDisplacement,a,b,c,"toDisplacement",d)},setText:function(a,b){return api.createCommand("ios","ios.setText",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","text",!0),{message:{cmd:"ios.text.setText",params:{query:c.normalizeQuery(a),text:b,typeText:!1}}}})},setDate:function(a,b){return api.createCommand("ios","ios.setDate",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"object","date",!1),{message:{cmd:"ios.setDate",params:{query:c.normalizeQuery(a),date:b.toISOString(),date_local:b.toLocalISOString()}}}})},scrollToRow:function(a,b,c,d){return api.createCommand("ios","ios.scrollToRow",function(e){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","row",!1,0),ValidateArgument(c,"number","section",!1,0),ValidateArgument(d,"number","tvScrollPos",!0)||(d=0),{message:{cmd:"ios.scrollToRow",params:{query:e.normalizeQuery(a),row:b,section:c,tvScrollPos:d}}}})},selectRow:function(a,b,c){return api.createCommand("ios","ios.selectRow",function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","row",!1,0),ValidateArgument(c,"number","section",!1,0),{message:{cmd:"ios.selectRow",params:{query:d.normalizeQuery(a),row:b,section:c}}}})},dragCellToIndexPath:function(a,b,c,d,e){return api.createCommand("ios","ios.dragCellToIndexPath",function(f){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","fromRow",!1,0),ValidateArgument(c,"number","fromSection",!1,0),ValidateArgument(d,"number","toRow",!1,0),ValidateArgument(e,"number","toSection",!1,0),{message:{cmd:"ios.dragCellToIndexPath",params:{query:f.normalizeQuery(a),fromRow:b,fromSection:c,toRow:d,toSection:e}}}})},scrollToItem:function(a,b,c,d){return api.createCommand("ios","ios.scrollToItem",function(e){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","item",!1,0),ValidateArgument(c,"number","section",!1,0),ValidateArgument(d,"number","cvScrollPos",!0)||(d=0),{message:{cmd:"ios.scrollToItem",params:{query:e.normalizeQuery(a),item:b,section:c,cvScrollPos:d}}}})},selectItem:function(a,b,c){return api.createCommand("ios","ios.selectItem",function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","item",!1,0),ValidateArgument(c,"number","section",!1,0),{message:{cmd:"ios.selectItem",params:{query:d.normalizeQuery(a),item:b,section:c}}}})},selectRowInComponent:function(a,b,c){return api.createCommand("ios","ios.selectRowInComponent",function(d){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","row",!1,0),ValidateArgument(c,"number","component",!1,0),{message:{cmd:"ios.selectRowInComponent",params:{query:d.normalizeQuery(a),row:b,component:c}}}})},toggle:function(a,b){return api.createCommand("ios","ios.toggle",function(c){return ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","toggleValue",!1),{message:{cmd:"ios.toggle",params:{query:c.normalizeQuery(a),toggleValue:b}}}})},setValue:function(a,b,c){return api.createCommand("ios","ios.range.setValue",function(d){ValidateArgument(a,"object","query",!1),ValidateArgument(b,"number","value",!1),ValidateArgument(c,"number","newTimeout",!0);var e=config.messageTimeout;return isNaN(c)||(e=c),{message:{cmd:"ios.range.setValue",params:{query:d.normalizeQuery(a),value:b}},options:{timeout:e}}})},typeText:function(a,b,c){return api.createCommand("ios","ios.typeText",function(d){ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","text",!1),ValidateArgument(c,"number","keyDelay",!0),isNaN(c)&&(c=100);var e=b.length*c+config.messageTimeout;return{message:{cmd:"ios.typeText",params:{query:d.normalizeQuery(a),strValue:b,keyDelay:c/1e3}},options:{timeout:e}}})},pressReturn:function(){return api.createCommand("ios","ios.pressReturn",function(a){return{message:{cmd:"ios.pressKey",params:{query:a.normalizeQuery({"class":"UIKeyboardLayoutStar"}),keyType:constants.keyType["return"]}}}})},pressDismiss:function(){return api.createCommand("ios","ios.pressDismiss",function(a){return{message:{cmd:"ios.pressKey",params:{query:a.normalizeQuery({"class":"UIKeyboardLayoutStar"}),keyType:constants.keyType.dismiss}}}})},automateWeb:function(a,b){return b.postSetup=function(c,d){if("web"!==b.platformKey)throw new Error("Invalid operation. Operation must be a web operation.");return"undefined"!=typeof d.message?{message:{cmd:"ios.automateWeb",params:{query:c.normalizeQuery(a),webCommand:d.message}}}:d},b},waitForElementExists:function(a,b,c,d){return api.createOperation("ios","ios.waitForElementExists",function(){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","exists",!1),ValidateArgument(c,"number","checkInterval",!1,0),ValidateArgument(d,"number","timeout",!1,0),c>d)throw new Error("Argument checkInterval cannot be greater than argument timeout.");return""},function(){return function(e,f){var g=(new Date).getTime()+d,h={cmd:"ios.elementExists",params:{query:f.normalizeQuery(a)}};return waitForMessageResponse(h,"exists",b,f,g,c)}})},waitForElementVisible:function(a,b,c,d){return api.createOperation("ios","ios.waitForElementVisible",function(){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"boolean","visible",!1),ValidateArgument(c,"number","checkInterval",!1,0),ValidateArgument(d,"number","timeout",!1,0),c>d)throw new Error("Argument checkInterval cannot be greater than argument timeout.");return""},function(){return function(e,f){var g=(new Date).getTime()+d,h={cmd:"ios.elementVisible",params:{query:f.normalizeQuery(a)}};return waitForMessageResponse(h,"isVisible",b,f,g,c)}})},waitForPropertyValue:function(a,b,c,d,e){return api.createOperation("ios","ios.waitForPropertyValue",function(){if(ValidateArgument(a,"object","query",!1),ValidateArgument(b,"string","property",!1),ValidateArgument(d,"number","checkInterval",!1,0),ValidateArgument(e,"number","timeout",!1,0),d>e)throw new Error("Argument checkInterval cannot be greater than argument timeout.");return""},function(){return function(f,g){var h=(new Date).getTime()+e,i={cmd:"ios.getValue",params:{query:g.normalizeQuery(a),property:b}};return waitForMessageResponse(i,"value",c,g,h,d)}})}};module.exports=iOSApi;